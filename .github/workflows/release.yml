name: Build and Release APK

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Decode Keystore
      run: |
        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/release.keystore
        chmod 600 app/release.keystore
        
        # 验证 keystore 文件
        echo "Keystore 文件大小: $(wc -c < app/release.keystore) bytes"
        
        # 列出 keystore 中的所有别名（用于调试）
        echo "=== Keystore 中的别名列表 ==="
        keytool -list \
          -keystore app/release.keystore \
          -storepass "${{ secrets.KEYSTORE_PASSWORD }}" 2>/dev/null || \
          echo "无法读取 keystore，密码可能错误"
    
    - name: Debug Key Alias
      run: |
        echo "=== 调试信息 ==="
        echo "从 Secret 读取的 KEY_ALIAS: '${{ secrets.KEY_ALIAS }}'"
        echo "KEY_ALIAS 变量长度: ${{ secrets.KEY_ALIAS.length }}"
        
        # 创建临时文件验证别名
        echo "测试别名: ${{ secrets.KEY_ALIAS }}" > alias_test.txt
        echo "文件内容: '$(cat alias_test.txt)'"
    
    - name: Build Release APK
      run: ./gradlew assembleRelease
      env:
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
    
    - name: Get version name
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: AutoGLM For Android ${{ steps.version.outputs.VERSION }}
        files: app/build/outputs/apk/release/*.apk
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
